<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192x192.png">
  <meta name="theme-color" content="#34A853"> <title>Ø¥Ø¯Ø§Ø±Ø© Ø±Ø§ØªØ¨ÙŠ - ØªØ·Ø¨ÙŠÙ‚Ùƒ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* Global Variables and Dark Mode */
    :root {
      --primary-color: #34A853; /* Vibrant Green */
      --primary-dark: #2C8C46; /* Darker Green */
      --accent-color: #4285F4; /* Google Blue */
      --background-color: #EEF5F9; /* Light Grayish Blue */
      --card-background: #FFFFFF; /* White */
      --text-color: #333333; /* Dark Gray */
      --light-text-color: #666666; /* Medium Gray */
      --border-color: #E0E0E0; /* Light Gray */
      --shadow-light: 0 8px 20px rgba(0, 0, 0, 0.08); /* More pronounced shadow */
      --border-radius: 16px; /* Larger border-radius for softer look */
      --input-border-radius: 10px;
      --button-padding: 14px 20px;
      --transition-speed: 0.3s ease;
    }

    body.dark-mode {
      --background-color: #1A1A2E; /* Dark Blue-Purple */
      --card-background: #2D2D44; /* Darker Blue-Purple */
      --text-color: #E0E0E0;
      --light-text-color: #AAAAAA;
      --border-color: #3A3A50;
      --shadow-light: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

    /* Base Styles */
    body {
      font-family: 'Cairo', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      padding: 25px; /* Increased padding */
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
      transition: background-color var(--transition-speed), color var(--transition-speed);
      overflow-x: hidden; /* Prevent horizontal scroll */
    }

    h1 {
      color: var(--primary-color);
      margin-bottom: 30px; /* Increased margin */
      font-size: 2.2em; /* Larger heading */
      font-weight: 800; /* Extra bold */
      text-align: center;
      letter-spacing: 0.5px;
    }

    h2, h3 {
      color: var(--text-color);
      margin-top: 0;
      margin-bottom: 20px;
      font-weight: 700;
      text-align: center;
    }

    /* Card Component */
    .card {
      background: var(--card-background);
      padding: 25px; /* Increased padding */
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
      max-width: 550px; /* Slightly wider */
      width: 100%;
      margin-bottom: 25px; /* Increased margin */
      transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
    }

    /* Form Elements */
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--light-text-color);
    }

    input[type="number"],
    input[type="text"],
    select {
      width: calc(100% - 24px); /* Account for padding */
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: var(--input-border-radius);
      font-family: 'Cairo', sans-serif;
      font-size: 1.05em;
      color: var(--text-color);
      background-color: var(--background-color); /* Match body background for a cleaner look */
      transition: border-color var(--transition-speed), background-color var(--transition-speed);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(52, 168, 83, 0.2);
    }

    /* Buttons */
    button {
      background-color: var(--primary-color);
      color: white;
      padding: var(--button-padding);
      border: none;
      border-radius: var(--input-border-radius); /* Match input border radius */
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 600;
      display: flex; /* For icon alignment */
      align-items: center;
      justify-content: center;
      gap: 8px; /* Space between text and icon */
      width: 100%;
      transition: background-color var(--transition-speed), transform 0.2s ease;
    }

    button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px); /* Slight lift effect */
    }

    button:active {
      transform: translateY(0);
    }

    /* Balance Grid */
    .balance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Responsive grid */
      gap: 15px; /* Increased gap */
      margin-top: 10px;
    }

    .balance-item {
      background: linear-gradient(135deg, #E8F5E9, #D4EDDA); /* Subtle gradient */
      border-radius: 12px; /* Softer corners */
      padding: 15px; /* More padding */
      text-align: center;
      box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.05); /* Inner shadow */
      color: var(--text-color);
      font-weight: 600;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background var(--transition-speed);
    }

    body.dark-mode .balance-item {
        background: linear-gradient(135deg, #3A3A50, #4A4A60);
        color: var(--text-color);
    }

    .balance-item span {
      display: block;
      margin-top: 5px;
      font-size: 1.4em; /* Larger balance numbers */
      font-weight: 700;
      color: var(--primary-color); /* Highlight balance values */
    }

    body.dark-mode .balance-item span {
        color: #90EE90; /* Lighter green for dark mode balances */
    }

    /* Log List */
    #logList {
      max-height: 250px; /* Taller scroll area */
      overflow-y: auto;
      border: 1px solid var(--border-color); /* Subtle border */
      border-radius: var(--input-border-radius);
      padding: 10px;
      background-color: var(--background-color); /* Match input background */
      transition: background-color var(--transition-speed), border-color var(--transition-speed);
    }

    .log-entry {
      background: var(--card-background);
      padding: 15px; /* More padding */
      margin-bottom: 10px;
      border-radius: 10px; /* Softer corners */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* Softer individual entry shadow */
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap; /* Allow wrapping on small screens */
      gap: 8px; /* Space between elements */
      border-right: 5px solid var(--accent-color); /* Highlight left border */
      transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
    }

    .log-entry:last-child {
      margin-bottom: 0;
    }

    .log-entry strong {
      font-size: 1.1em;
      color: var(--primary-color);
    }

    .log-entry small {
      font-size: 0.85em;
      color: var(--light-text-color);
    }

    /* Chart */
    #expenseChart {
      max-width: 350px; /* Slightly smaller chart */
      margin: auto;
    }

    /* Utility Classes */
    .filters, .dark-toggle, .export-button {
      margin-top: 15px; /* More spacing */
      margin-bottom: 25px; /* Consistent spacing */
      width: 100%;
      max-width: 550px;
      text-align: center;
    }

    .calendar-placeholder {
      background: #FFF3E0;
      padding: 20px; /* More padding */
      border-radius: var(--border-radius);
      text-align: center;
      color: #BF360C;
      font-weight: 700;
      border: 2px dashed #FFC107; /* Dashed border for attention */
      font-size: 1.1em;
      line-height: 1.5;
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    body.dark-mode .calendar-placeholder {
        background: #3A2B00;
        color: #FFD700;
        border-color: #FFA500;
    }

    /* Responsive Adjustments */
    @media (max-width: 600px) {
      body {
        padding: 15px;
      }
      .card {
        padding: 20px;
      }
      h1 {
        font-size: 1.8em;
        margin-bottom: 20px;
      }
      .balance-grid {
        grid-template-columns: 1fr; /* Stack items on small screens */
      }
      .log-entry {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <h1><i class="fas fa-sack-dollar"></i> Ø¥Ø¯Ø§Ø±Ø© Ø±Ø§ØªØ¨ÙŠ Ø§Ù„Ø°ÙƒÙŠØ© <i class="fas fa-chart-pie"></i></h1>

  <div class="filters card">
    <label for="filterCategory"><i class="fas fa-filter"></i> ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©:</label>
    <select id="filterCategory" onchange="updateUI()">
      <option value="all">Ø§Ù„ÙƒÙ„</option>
      <option value="essentials">Ø¶Ø±ÙˆØ±ÙŠ</option>
      <option value="secondary">Ø«Ø§Ù†ÙˆÙŠ</option>
      <option value="improvements">ØªØ­Ø³ÙŠÙ†ÙŠ</option>
    </select>
  </div>

  <div class="dark-toggle card">
    <button onclick="toggleDarkMode()"><i class="fas fa-moon"></i> ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</button>
  </div>

  <div class="card">
    <h2><i class="fas fa-coins"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h2>
    <input type="number" id="salaryInput" placeholder="ğŸ“¥ Ø£Ø¯Ø®Ù„ Ø±Ø§ØªØ¨Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ" min="0">
    <input type="number" id="essentialsPercent" value="50" placeholder="Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ§Øª %" min="0" max="100">
    <input type="number" id="secondaryPercent" value="30" placeholder="Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ§Øª %" min="0" max="100">
    <input type="number" id="improvementsPercent" value="20" placeholder="Ø§Ù„ØªØ­Ø³ÙŠÙ†ÙŠØ§Øª %" min="0" max="100">
    <button onclick="setBudget()"><i class="fas fa-dollar-sign"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±Ø§ØªØ¨</button>
  </div>

  <div class="card" id="balances" style="display:none;">
    <h2><i class="fas fa-wallet"></i> Ø£Ø±ØµØ¯Ø© Ø§Ù„ÙØ¦Ø§Øª</h2>
    <div class="balance-grid">
      <div class="balance-item">
        ğŸ’¼ Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ§Øª: <span id="balanceEssentials">0</span> Ø¯Ø¬
      </div>
      <div class="balance-item">
        ğŸ§¥ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ§Øª: <span id="balanceSecondary">0</span> Ø¯Ø¬
      </div>
      <div class="balance-item">
        ğŸ Ø§Ù„ØªØ­Ø³ÙŠÙ†ÙŠØ§Øª: <span id="balanceImprovements">0</span> Ø¯Ø¬
      </div>
    </div>
  </div>

  <div class="card" id="expenseForm" style="display:none;">
    <h2><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h2>
    <input type="text" id="expenseName" placeholder="âœï¸ Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ" required>
    <input type="number" id="expenseAmount" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" min="0" required>
    <select id="expenseCategory">
      <option value="essentials">Ø¶Ø±ÙˆØ±ÙŠ</option>
      <option value="secondary">Ø«Ø§Ù†ÙˆÙŠ</option>
      <option value="improvements">ØªØ­Ø³ÙŠÙ†ÙŠ</option>
    </select>
    <button onclick="addExpense()"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©</button>
  </div>

  <div class="card" id="logSection" style="display:none;">
    <h2><i class="fas fa-receipt"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>
    <div id="logList"></div>
    <div class="export-button">
      <button onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF</button>
    </div>
  </div>

  <div class="card">
    <h2><i class="fas fa-calendar-alt"></i> ØªÙ‚ÙˆÙŠÙ… Ù…Ø§Ù„ÙŠ Ø´Ù‡Ø±ÙŠ (ØªØ¬Ø±ÙŠØ¨ÙŠ)</h2>
    <div class="calendar-placeholder">
      <i class="fas fa-hourglass-half"></i> <br>
      Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± ÙˆØ³ØªØªÙˆÙØ± Ù‚Ø±ÙŠØ¨Ù‹Ø§. ØªØ±Ù‚Ø¨ÙˆØ§ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª!
    </div>
  </div>

  <div class="card">
    <h2><i class="fas fa-chart-pie"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>
    <canvas id="expenseChart"></canvas>
  </div>

  <script>
    // Register Service Worker for PWA capabilities
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js') // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù service-worker.js
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }

    let budget = JSON.parse(localStorage.getItem("budget") || "null");
    let balances = JSON.parse(localStorage.getItem("balances") || "null");
    let log = JSON.parse(localStorage.getItem("log") || "[]");

    const tips = [
      "ğŸ’¡ Ø­Ø§ÙˆÙ„ ØªÙˆÙÙŠØ± 10% Ù…Ù† Ø±Ø§ØªØ¨Ùƒ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦. Ø§Ù„Ù…Ø¯Ø®Ø±Ø§Øª Ù‡ÙŠ Ù…ÙØªØ§Ø­ Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ!",
      "ğŸ“Œ Ø±Ø§Ø¬Ø¹ Ù…ØµØ§Ø±ÙŠÙÙƒ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù„ØªØ¨Ù‚Ù‰ Ø¹Ù„Ù‰ Ø§Ø·Ù„Ø§Ø¹ Ø¨Ø¥Ù†ÙØ§Ù‚Ùƒ ÙˆØªØ¬Ù†Ø¨ Ø§Ù„Ù…ÙØ§Ø¬Ø¢Øª.",
      "ğŸª™ Ø§Ø­Ø°Ù Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©. ÙƒÙ„ Ø¯ÙŠÙ†Ø§Ø± ØªÙˆÙØ±Ù‡ ÙŠØ¶Ø§Ù Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ!",
      "ğŸ’° Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¹Ø¯Ø© 50/30/20: 50% Ù„Ù„Ø¶Ø±ÙˆØ±ÙŠØ§ØªØŒ 30% Ù„Ù„Ø«Ø§Ù†ÙˆÙŠØ§ØªØŒ 20% Ù„Ù„Ù…Ø¯Ø®Ø±Ø§Øª ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†.",
      "ğŸ’¸ Ø¶Ø¹ Ù„Ù†ÙØ³Ùƒ Ø£Ù‡Ø¯Ø§ÙØ§Ù‹ Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ø¶Ø­Ø©ØŒ Ø³ÙˆØ§Ø¡ ÙƒØ§Ù†Øª ØµØºÙŠØ±Ø© Ø£Ùˆ ÙƒØ¨ÙŠØ±Ø©ØŒ Ù„ØªØ­ÙÙŠØ²Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø¯Ø®Ø§Ø±."
    ];

    function showRandomTip() {
      const tip = tips[Math.floor(Math.random() * tips.length)];
      alert(tip);
    }

    function setBudget() {
      const salaryInput = document.getElementById("salaryInput");
      const p1Input = document.getElementById("essentialsPercent");
      const p2Input = document.getElementById("secondaryPercent");
      const p3Input = document.getElementById("improvementsPercent");

      const salary = parseFloat(salaryInput.value);
      const p1 = parseFloat(p1Input.value);
      const p2 = parseFloat(p2Input.value);
      const p3 = parseFloat(p3Input.value);

      if (isNaN(salary) || salary <= 0 || isNaN(p1) || isNaN(p2) || isNaN(p3) || (p1 + p2 + p3 !== 100)) {
        alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø§ØªØ¨ Ø±Ù‚Ù…Ø§Ù‹ Ù…ÙˆØ¬Ø¨Ø§Ù‹ ÙˆØ£Ù† ÙŠÙƒÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ 100%.");
        return;
      }

      budget = { salary, p1, p2, p3 };
      balances = {
        essentials: salary * p1 / 100,
        secondary: salary * p2 / 100,
        improvements: salary * p3 / 100
      };
      log = []; // Reset log on new budget
      localStorage.setItem("budget", JSON.stringify(budget));
      localStorage.setItem("balances", JSON.stringify(balances));
      localStorage.setItem("log", JSON.stringify(log));
      updateUI();
      showRandomTip();

      // Clear input fields after successful budget setting
      salaryInput.value = '';
      p1Input.value = '50';
      p2Input.value = '30';
      p3Input.value = '20';
    }

    function addExpense() {
      const nameInput = document.getElementById("expenseName");
      const amountInput = document.getElementById("expenseAmount");
      const categorySelect = document.getElementById("expenseCategory");

      const name = nameInput.value.trim(); // Trim whitespace
      const amount = parseFloat(amountInput.value);
      const category = categorySelect.value;

      if (!name || isNaN(amount) || amount <= 0 || !balances[category] || balances[category] < amount) {
        alert("ğŸš« ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­ÙŠÙ†ØŒ ÙˆØ£Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„ÙØ¦Ø©.");
        return;
      }

      balances[category] -= amount;
      const entry = { name, amount, category, date: new Date().toLocaleDateString("ar-DZ") };
      log.push(entry);
      localStorage.setItem("balances", JSON.stringify(balances));
      localStorage.setItem("log", JSON.stringify(log));
      updateUI();
      showRandomTip();

      // Clear input fields after adding expense
      nameInput.value = '';
      amountInput.value = '';
      categorySelect.value = 'essentials'; // Reset to default
    }

    let expenseChartInstance = null; // To store chart instance

    function updateUI() {
      if (!budget || !balances) {
        // Hide relevant sections if budget not set
        document.getElementById("balances").style.display = "none";
        document.getElementById("expenseForm").style.display = "none";
        document.getElementById("logSection").style.display = "none";
        return;
      }
      document.getElementById("balances").style.display = "block";
      document.getElementById("expenseForm").style.display = "block";
      document.getElementById("logSection").style.display = "block";

      document.getElementById("balanceEssentials").textContent = balances.essentials.toFixed(2);
      document.getElementById("balanceSecondary").textContent = balances.secondary.toFixed(2);
      document.getElementById("balanceImprovements").textContent = balances.improvements.toFixed(2);

      const filter = document.getElementById("filterCategory").value;
      const list = document.getElementById("logList");
      list.innerHTML = ""; // Clear existing entries

      const filteredLog = log.filter(e => filter === "all" || e.category === filter);

      if (filteredLog.length === 0) {
        list.innerHTML = '<div style="text-align: center; color: var(--light-text-color); padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©.</div>';
      } else {
        filteredLog.slice().reverse().forEach(e => {
          const div = document.createElement("div");
          div.className = "log-entry";
          div.innerHTML = `
            <div><strong>${e.name}</strong> - <span style="color: ${e.category === 'essentials' ? '#4CAF50' : e.category === 'secondary' ? '#FFC107' : '#2196F3'};">${e.amount.toFixed(2)} Ø¯Ø¬</span></div>
            <small>${e.date} | Ø§Ù„ÙØ¦Ø©: ${e.category === 'essentials' ? 'Ø¶Ø±ÙˆØ±ÙŠ' : e.category === 'secondary' ? 'Ø«Ø§Ù†ÙˆÙŠ' : 'ØªØ­Ø³ÙŠÙ†ÙŠ'}</small>
          `;
          list.appendChild(div);
        });
      }

      updateChart();
    }

    function updateChart() {
      // Destroy old chart instance if it exists
      if (expenseChartInstance) {
        expenseChartInstance.destroy();
      }

      const totalSpentEssentials = log.filter(e => e.category === 'essentials').reduce((sum, entry) => sum + entry.amount, 0);
      const totalSpentSecondary = log.filter(e => e.category === 'secondary').reduce((sum, entry) => sum + entry.amount, 0);
      const totalSpentImprovements = log.filter(e => e.category === 'improvements').reduce((sum, entry) => sum + entry.amount, 0);

      const chartData = [
        budget.salary * budget.p1 / 100 - totalSpentEssentials,
        budget.salary * budget.p2 / 100 - totalSpentSecondary,
        budget.salary * budget.p3 / 100 - totalSpentImprovements
      ];

      expenseChartInstance = new Chart(document.getElementById("expenseChart"), {
        type: 'doughnut',
        data: {
          labels: ["Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙÙŠ Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ§Øª", "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ§Øª", "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙÙŠ Ø§Ù„ØªØ­Ø³ÙŠÙ†ÙŠØ§Øª"],
          datasets: [{
            data: chartData,
            backgroundColor: ["#4CAF50", "#FFC107", "#2196F3"],
            hoverOffset: 8,
            borderColor: var(--card-background), /* Match card background for better blending */
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: getComputedStyle(document.body).getPropertyValue('--text-color'),
                font: {
                  family: 'Cairo, sans-serif',
                  size: 14
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed !== null) {
                    label += context.parsed.toFixed(2) + ' Ø¯Ø¬';
                  }
                  return label;
                }
              },
              bodyFont: {
                family: 'Cairo, sans-serif'
              },
              titleFont: {
                family: 'Cairo, sans-serif'
              }
            }
          }
        }
      });
    }


    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        unit: "mm",
        format: "a4",
        orientation: "portrait"
      });

      // Add Arabic font support (requires a font file to be loaded or embedded)
      // For simplicity, we'll use a basic approach here. For full Arabic support,
      // you might need to embed a font like 'Amiri' or 'Scheherazade' and use jspdf-arabic
      // You can find more details on jspdf-arabic: https://github.com/MrMYousuf/jspdf-arabic

      const tableColumn = ["Ø§Ù„ÙØ¦Ø©", "Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯Ø¬)", "Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ", "Ø§Ù„ØªØ§Ø±ÙŠØ®"];
      const tableRows = [];

      log.forEach(e => {
        tableRows.push([
          e.category === 'essentials' ? 'Ø¶Ø±ÙˆØ±ÙŠ' : e.category === 'secondary' ? 'Ø«Ø§Ù†ÙˆÙŠ' : 'ØªØ­Ø³ÙŠÙ†ÙŠ',
          e.amount.toFixed(2),
          e.name,
          e.date
        ]);
      });

      doc.setFont("helvetica", "bold");
      doc.text("Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª", doc.internal.pageSize.width / 2, 20, { align: "center" });

      doc.autoTable({
        startY: 30,
        head: [tableColumn],
        body: tableRows,
        styles: {
          font: "helvetica",
          fontSize: 10,
          halign: 'right' // Align text to right for Arabic
        },
        headStyles: {
          fillColor: [52, 168, 83], // Primary color for table header
          textColor: 255,
          halign: 'right'
        },
        columnStyles: {
          0: { halign: 'right' }, // Category
          1: { halign: 'right' }, // Amount
          2: { halign: 'right' }, // Name
          3: { halign: 'right' }  // Date
        },
        margin: { top: 25 }
      });

      doc.save("Ø³Ø¬Ù„-Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª.pdf");
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      // Update chart colors if in dark mode
      if (expenseChartInstance) {
          const textColor = getComputedStyle(document.body).getPropertyValue('--text-color');
          const cardBackground = getComputedStyle(document.body).getPropertyValue('--card-background');
          expenseChartInstance.options.plugins.legend.labels.color = textColor;
          expenseChartInstance.data.datasets[0].borderColor = cardBackground;
          expenseChartInstance.update();
      }
    }

    // Initial load and UI update
    document.addEventListener('DOMContentLoaded', () => {
      updateUI();
      // Apply dark mode preference on load if exists
      if (localStorage.getItem('darkMode') === 'enabled') {
          document.body.classList.add('dark-mode');
      }
    });

    // Save dark mode preference
    document.body.addEventListener('transitionend', (e) => {
        if (e.propertyName === 'background-color' && e.target === document.body) {
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'enabled');
            } else {
                localStorage.removeItem('darkMode');
            }
        }
    });
  </script>
</body>
</html>
